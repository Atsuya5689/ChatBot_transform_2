<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Context-Aware Avatar (Minimal UI)</title>
  <style>
    :root{
      --bg:#f6f9ff; --card:#ffffff; --muted:#7b8794; --accent:#8ecae6; --accent-deep:#5fb3d7;
      --line:#e6eef8; --ink:#1f2a37; --bubble-user:#dbeeff; --bubble-bot:#eef5ff; --input:#ffffff; --chip-ink:#0b0f12;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    header{padding:14px 18px;border-bottom:1px solid var(--line);background:#f0f7ff; display:flex;gap:12px;align-items:center}
    header h1{font-size:16px;margin:0;font-weight:700;color:var(--ink)}
    header .pill{font-size:12px;color:var(--chip-ink);background:var(--accent);padding:2px 8px;border-radius:999px}
    main{display:grid;grid-template-columns:300px 1fr;gap:14px;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(30,64,175,.06);}
    .section{padding:12px}
    .title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
    #avatar{width:100%;aspect-ratio:1;display:block;border-radius:10px;background:#f3f8ff;border:1px dashed #b8d8f0;object-fit:cover}
    #ctx{height:120px;width:100%;resize:vertical;background:var(--input);color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
    #chat{height:360px;overflow:auto;padding:12px}
    .bubble{max-width:78%;padding:8px 10px;border-radius:12px;margin:6px 0;white-space:pre-wrap;border:1px solid var(--line)}
    .user{background:var(--bubble-user);margin-left:auto}
    .bot{background:var(--bubble-bot)}
    .row{display:flex;gap:8px;align-items:center}
    input,button,select,textarea{background:var(--input);color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{cursor:pointer;transition:.15s ease}
    button.primary{background:var(--accent);color:#073141;border:none}
    button.primary:hover{background:var(--accent-deep)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(142,202,230,.35)}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .small{font-size:12px}
    .badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:#476581;background:#eef6ff}
    footer{padding:10px 14px;color:#6b7785}
  </style>
</head>
<body>
  <header>
    <h1>Context-Aware Avatar — Minimal Prototype</h1>
    <span class="pill">demo</span>
    <span class="badge" id="turnBadge">Turn: 0</span>
    <span class="badge" id="nextBadge">Next transform at: 11</span>
  </header>

  <main>
    <!-- LEFT: Avatar + Controls -->
    <div class="card">
      <div class="section">
        <div class="title">Avatar</div>
        <canvas id="avatarCanvas" width="800" height="800" style="width:100%;aspect-ratio:1;border-radius:10px;background:#0b1014;border:1px dashed #32424f;"></canvas>
        <div class="small muted" id="status">Idle</div>
        <select id="condition" style="margin-top:8px">
          <option value="context">Context-adaptive</option>
          <option value="static">Static (no change)</option>
          <option value="random">Random change</option>
        </select>
      </div>
    </div>

    <!-- RIGHT: Chat / Context -->
    <div class="card" style="display:flex;flex-direction:column;min-height:640px;">
      <div class="section">
        <div class="title">Conversation</div>
        <div id="chat" class="card"></div>
        <div class="row" style="padding:8px 0 0 0;">
          <input id="msg" placeholder="Type a message… (Enter to send)" style="flex:1" />
          <button id="send" class="primary">Send</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Survey modal -->
  <div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;">
    <div class="card" style="width:560px;max-width:90vw;">
      <div class="section">
        <div class="title">Quick Survey (7-point Likert)</div>
        <div class="small">Please rate the transformed appearance.</div>
        <div class="hr"></div>
        <div class="small">1) The change matched the conversation context.</div>
        <input type="range" id="q1" min="1" max="7" value="4"/>
        <div class="small">2) The change felt natural and smooth.</div>
        <input type="range" id="q2" min="1" max="7" value="4"/>
        <div class="small">3) The change increased my familiarity/trust.</div>
        <input type="range" id="q3" min="1" max="7" value="4"/>
        <div class="small">Comments</div>
        <textarea id="qfree" style="width:100%;height:80px"></textarea>
        <div class="hr"></div>
        <div class="row" style="justify-content:flex-end;">
          <button id="cancelModal">Cancel</button>
          <button id="saveModal" class="primary">Save to log</button>
        </div>
      </div>
    </div>
  </div>

  <footer></footer>

  <script>
    // ===== Config =====
    const PROD_API = 'https://chatbot-transform-1s.onrender.com/api';
    const API_BASE =
      (location.hostname.endsWith('onrender.com') || location.protocol === 'https:')
        ? PROD_API
        : 'http://localhost:8787/api';
    console.log('[API_BASE]', API_BASE)
    const el = (id)=>document.getElementById(id);

    // ===== State =====
    window.state = {
      turns: 0,
      messages: [],
      prepared: null,
      current: { hint: 'neutral casual', img: './img/FirstAvatar.png' },
      condition: 'context',
      auto: true,
      surveys: [],
    };

    // ===== Utils =====
    function setStatus(s){ const x=el('status'); if(x) x.textContent = s; }
    function renderBadges(){
      const t = state.turns;
      const n = Math.floor(t/10)*10 + 11;
      el('turnBadge').textContent = `Turn: ${t}`;
      el('nextBadge').textContent = `Next transform at: ${n}`;
    }
    function last10Text(){
      const slice = state.messages.slice(-10);
      return slice.map(m=>`- ${m.role}: ${m.text}`).join('\n');
    }

    // ===== Heuristic fallback =====
    function inferTopics(text){
      const topics = [];
      [
        [/travel|trip|flight|hotel|vacation|旅|旅行/gi,'travel'],
        [/study|class|homework|exam|learn|勉強|授業|学習/gi,'study'],
        [/sport|game|team|match|soccer|basket|野球|サッカー|スポーツ/gi,'sports'],
        [/work|meeting|business|office|仕事|会議/gi,'business'],
        [/weather|hot|cold|暑|寒/gi,'weather'],
      ].forEach(([re,tag])=>{ if(re.test(text)) topics.push(tag); });
      return topics.length?topics:['casual'];
    }
    function inferSentiment(text){
      const pos = /great|good|楽しい|嬉しい|最高|nice|love/gi.test(text);
      const neg = /bad|sad|angry|怖い|嫌|大変|つら/gi.test(text);
      return pos && !neg ? 'positive' : (!pos && neg ? 'negative' : 'neutral');
    }
    function styleHintFromTopics(topics){
      if(topics.includes('study')) return 'tutor-like (glasses, simple formal)';
      if(topics.includes('business')) return 'business casual (jacket)';
      if(topics.includes('sports')) return 'sporty (jersey, cap)';
      if(topics.includes('travel')) return 'travel casual (backpack)';
      return 'neutral casual';
    }
    function mockSummary(text){
      const topics = inferTopics(text);
      const hint = styleHintFromTopics(topics);
      return `Topics: ${topics.join(', ')}\nSentiment: ${inferSentiment(text)}\nStyle hint: ${hint}\n\n${text}`;
    }

    // ===== Server calls (JSON) =====
    async function chatWithServer(messages){
      const r = await fetch(`${API_BASE}/chat`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ messages })
      });
      if(!r.ok) throw new Error(await r.text());
      const { reply } = await r.json();
      return reply;
    }
    async function summarizeWithServer(last10Messages){
      const r = await fetch(`${API_BASE}/summarize`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ messages: last10Messages })
      });
      if(!r.ok) throw new Error(await r.text());
      const { topics, sentiment, hint } = await r.json();
      return `Topics: ${topics}\nSentiment: ${sentiment}\nStyle hint: ${hint}`;
    }
    // 画像生成成功で state.current.img を更新し、canvas に再描画
    async function generateAvatarWithServer(hint){
      try {
        const r = await fetch(`${API_BASE}/generate-avatar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hint })
        });
        if (!r.ok) throw new Error(await r.text());
        const { dataUrl } = await r.json();
        if (!dataUrl) throw new Error('no image');

        state.current.img = dataUrl;
        drawAvatar();
        return dataUrl;
      } catch (e) {
        console.error('[generateAvatarWithServer] failed:', e);
        const fallback = state.current.img || './img/FirstAvatar.png';
        state.current.img = fallback;
        drawAvatar();
        return fallback;
      }
    }

    // ===== Core flow =====
    async function autoSummarizeAndPrepare(){
      const slice10 = state.messages.slice(-10).map(m => ({ role: m.role, text: m.text }));
      try {
        const summary = await summarizeWithServer(slice10);
        const ctx = el('ctx'); if (ctx) ctx.value = summary;

        let hint = 'neutral casual';
        const m = /Style hint:\s*(.*)/i.exec(summary || '');
        if (m && m[1]) hint = m[1].trim();

        setStatus('Preparing appearance…');
        const img = (state.condition === 'static')
          ? state.current.img
          : await generateAvatarWithServer(hint);

        state.prepared = { hint, img: img || null };
        setStatus('Prepared. Ready to swap at next turn.');
      } catch(e){
        console.error('[autoSummarizeAndPrepare]', e);
        const text = last10Text();
        const ctx2 = el('ctx'); if (ctx2) ctx2.value = mockSummary(text);
        const hint = styleHintFromTopics(inferTopics(text));
        try{
          const img = (state.condition === 'static')
            ? state.current.img
            : await generateAvatarWithServer(hint);
          state.prepared = { hint, img: img || null };
          setStatus('Prepared (fallback).');
        } catch(e2){
          console.error('[fallback generate]', e2);
          state.prepared = { hint, img: null };
          setStatus('Prepared (no image).');
        }
      }
    }

    async function prepareAppearance(){ return autoSummarizeAndPrepare(); }

    function swapAppearance(){
      if(!state.prepared){ setStatus('No prepared image.'); return; }
      state.current = state.prepared;
      state.prepared = null;
      setStatus('Swapped.');
      drawAvatar();
      openSurvey();
    }

    // ===== Render =====
    function drawAvatar(){
      const cvs = el('avatarCanvas'); if(!cvs) return;
      const g = cvs.getContext('2d');

      if (state.current?.img){
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=>{ g.clearRect(0,0,cvs.width,cvs.height); g.drawImage(img,0,0,cvs.width,cvs.height); };
        img.src = state.current.img;
        return;
      }

      g.clearRect(0,0,cvs.width,cvs.height);
      g.fillStyle = '#10161c'; g.fillRect(0,0,cvs.width,cvs.height);
      g.fillStyle = '#c8d1d9'; g.beginPath(); g.arc(400,320,140,0,Math.PI*2); g.fill();
      g.fillStyle = '#1e2730'; g.fillRect(230,460,340,220);
      const h = (state.current?.hint || 'neutral casual');
      g.fillStyle = '#4dc9ff';
      if(h.includes('sporty')) g.fillRect(230,520,340,50);
      if(h.includes('business')) g.fillRect(230,580,340,50);
      if(h.includes('travel')) g.fillRect(230,640,340,50);
      if(h.includes('tutor')) g.fillRect(230,560,340,70);
      g.fillStyle = '#9fb3c8'; g.font = 'bold 28px system-ui';
      g.fillText(h, 40, 760);
    }

    // ===== Survey =====
    function openSurvey(){ const m = el('modal'); if(m) m.style.display='flex'; }
    function closeSurvey(){ const m = el('modal'); if(m) m.style.display='none'; }
    function bindSurvey(){
      const save = el('saveModal'), cancel = el('cancelModal');
      if(save){
        save.onclick = ()=>{
          state.surveys.push({
            turn: state.turns,
            q1: Number(el('q1').value),
            q2: Number(el('q2').value),
            q3: Number(el('q3').value),
            comment: el('qfree').value,
            hint: state.current?.hint || 'neutral',
            condition: state.condition,
            t: Date.now(),
          });
          el('qfree').value=''; el('q1').value=4; el('q2').value=4; el('q3').value=4;
          closeSurvey();
        };
      }
      if(cancel) cancel.onclick = closeSurvey;
    }

    // ===== Boot & events =====
    function pushMessage(role, text){
      state.turns += 1;
      const t = Date.now();
      state.messages.push({role, text, t});

      const chatEl = el('chat');
      if(chatEl){
        const b = document.createElement('div');
        b.className = 'bubble ' + (role==='user'?'user':'bot');
        b.textContent = text;
        chatEl.appendChild(b);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      renderBadges();

      if(state.turns % 10 === 0){ autoSummarizeAndPrepare(); }
      if(state.auto && (state.turns % 11 === 0)) swapAppearance();

      drawAvatar();
    }

    function boot(){
      const send = el('send'), msg = el('msg');
      if(send){
        send.onclick = async ()=>{
          const v = msg.value.trim(); if(!v) return;
          msg.value = '';
          pushMessage('user', v);

          try{
            const lastTurns = state.messages.slice(-10).map(m => ({ role: m.role, text: m.text }));
            const reply = await chatWithServer(lastTurns);
            pushMessage('bot', reply);
          }catch(e){
            console.error(e);
            pushMessage('bot', 'ごめん、少し調子が悪いみたい。');
          }
        };
      }
      if(msg){
        msg.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){ e.preventDefault(); send?.click(); }
        });
      }

      bindSurvey();
      renderBadges(); drawAvatar(); setStatus('Idle');
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }
  </script>
</body>
</html>
